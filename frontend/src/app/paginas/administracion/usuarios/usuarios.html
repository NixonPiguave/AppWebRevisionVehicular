<div class="usuarios-container">
  <!-- Mensaje exito -->
  <div class="mensaje-exito" *ngIf="mensajeExito">
    <mat-icon>check_circle</mat-icon>
    {{ mensajeExito }}
  </div>

  <!-- Mensaje error -->
  <div class="mensaje-error" *ngIf="mensajeError">
    <mat-icon>error</mat-icon>
    {{ mensajeError }}
  </div>

  <!-- Loading -->
  <div class="cargando" *ngIf="cargando && !mensajeError">
    Cargando usuarios...
  </div>

  <!-- Contenido principal -->
  <div *ngIf="!cargando || mensajeError">
    <!-- Header con título y botón agregar -->
    <div class="usuarios-header">
      <h2>Gestión de Usuarios</h2>
      <button class="btn-agregar" (click)="abrirModalCrear()">
        <mat-icon>add</mat-icon>
        Nuevo Usuario
      </button>
    </div>

    <!-- Controles de filtro y paginación -->
    <div class="usuarios-controles">
      <div class="control-grupo">
        <label for="filtro">Buscar:</label>
        <input
          type="text"
          id="filtro"
          [(ngModel)]="terminoBusqueda"
          (ngModelChange)="filtrarUsuarios()"
          placeholder="Buscar por nombre, usuario, email..."
          class="input-filtro"
        />
      </div>
      <div class="control-grupo">
        <label for="registros">Mostrar:</label>
        <select
          id="registros"
          [(ngModel)]="elementosPorPagina"
          (ngModelChange)="filtrarUsuarios()"
          class="select-registros"
        >
          <option [value]="5">5</option>
          <option [value]="10">10</option>
          <option [value]="25">25</option>
          <option [value]="50">50</option>
        </select>
        <span class="registros-texto">registros</span>
      </div>
    </div>

    <!-- Tabla -->
    <div class="tabla-contenedor">
      <table class="usuarios-tabla">
        <thead>
        <tr>
          <th>ID</th>
          <th>Nombre Completo</th>
          <th>Usuario</th>
          <th>Email</th>
          <th>Documento</th>
          <th>Área</th>
          <th>Empresa</th>
          <th>Roles</th>
          <th>Estado</th>
          <th class="th-acciones">Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let usuario of usuariosPaginados">
          <td>{{ usuario.usuarioId }}</td>
          <td>{{ usuario.nombre }} {{ usuario.apellido }}</td>
          <td>{{ usuario.usuario }}</td>
          <td>{{ usuario.email }}</td>
          <td>{{ usuario.documentoIdentidad }}</td>
          <td>{{ obtenerNombreArea(usuario.areaId) }}</td>
          <td>{{ obtenerNombreEmpresa(usuario.empresaId) }}</td>
          <td>
            <div class="roles-badges">
              <span class="role-badge" *ngFor="let rol of usuario.roles">{{ rol.nombre }}</span>
              <span *ngIf="!usuario.roles || usuario.roles.length === 0" class="sin-roles">Sin roles</span>
            </div>
          </td>
          <td>
              <span class="estado-badge" [class.estado-activo]="usuario.estado === 'Activo'" [class.estado-inactivo]="usuario.estado !== 'Activo'">
                {{ usuario.estado }}
              </span>
          </td>
          <td class="td-acciones">
            <button class="btn-accion btn-ver" (click)="abrirModalDetalle(usuario)" title="Ver detalle">
              <mat-icon>visibility</mat-icon>
            </button>
            <button class="btn-accion btn-editar" (click)="abrirModalEditar(usuario)" title="Editar">
              <mat-icon>edit</mat-icon>
            </button>
          </td>
        </tr>
        <tr *ngIf="usuariosPaginados.length === 0 && !mensajeError && !cargando">
          <td colspan="10" class="sin-registros">No se encontraron registros</td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="paginacion" *ngIf="totalPaginas > 1">
      <button
        class="btn-pagina"
        (click)="cambiarPagina(paginaActual - 1)"
        [disabled]="paginaActual === 1"
      >
        <mat-icon>chevron_left</mat-icon>
      </button>
      <button
        *ngFor="let pagina of paginasArray"
        class="btn-pagina"
        [class.activa]="pagina === paginaActual"
        (click)="cambiarPagina(pagina)"
      >
        {{ pagina }}
      </button>
      <button
        class="btn-pagina"
        (click)="cambiarPagina(paginaActual + 1)"
        [disabled]="paginaActual === totalPaginas"
      >
        <mat-icon>chevron_right</mat-icon>
      </button>
    </div>

    <!-- Info de registros -->
    <div class="info-registros" *ngIf="usuariosFiltrados.length > 0">
      Mostrando {{ (paginaActual - 1) * elementosPorPagina + 1 }} a
      {{ paginaActual * elementosPorPagina > usuariosFiltrados.length ? usuariosFiltrados.length : paginaActual * elementosPorPagina }}
      de {{ usuariosFiltrados.length }} registros
    </div>
  </div>
</div>

<!-- Modal Crear/Editar -->
<div class="modal-overlay" *ngIf="mostrarModalForm" (click)="cerrarModalForm()">
  <div class="modal-contenido" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ modoEdicion ? 'Editar Usuario' : 'Nuevo Usuario' }}</h3>
      <button class="btn-cerrar" (click)="cerrarModalForm()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="modal-body">
      <!-- Fila 1: Nombre y Apellido -->
      <div class="form-row">
        <div class="form-grupo">
          <label>Nombre <span class="requerido">*</span></label>
          <input
            type="text"
            [(ngModel)]="usuarioEditando.nombre"
            [class.error]="erroresValidacion['nombre']"
            placeholder="Ingrese el nombre"
            class="form-input"
          />
          <span class="error-text" *ngIf="erroresValidacion['nombre']">{{ erroresValidacion['nombre'] }}</span>
        </div>
        <div class="form-grupo">
          <label>Apellido <span class="requerido">*</span></label>
          <input
            type="text"
            [(ngModel)]="usuarioEditando.apellido"
            [class.error]="erroresValidacion['apellido']"
            placeholder="Ingrese el apellido"
            class="form-input"
          />
          <span class="error-text" *ngIf="erroresValidacion['apellido']">{{ erroresValidacion['apellido'] }}</span>
        </div>
      </div>

      <!-- Fila 2: Usuario y Documento -->
      <div class="form-row">
        <div class="form-grupo">
          <label>Usuario <span class="requerido">*</span></label>
          <input
            type="text"
            [(ngModel)]="usuarioEditando.usuario"
            [class.error]="erroresValidacion['usuario']"
            placeholder="Ingrese el usuario"
            class="form-input"
          />
          <span class="error-text" *ngIf="erroresValidacion['usuario']">{{ erroresValidacion['usuario'] }}</span>
        </div>
        <div class="form-grupo">
          <label>Documento de Identidad <span class="requerido">*</span></label>
          <input
            type="text"
            [(ngModel)]="usuarioEditando.documentoIdentidad"
            [class.error]="erroresValidacion['documentoIdentidad']"
            placeholder="Ingrese el documento"
            class="form-input"
          />
          <span class="error-text" *ngIf="erroresValidacion['documentoIdentidad']">{{ erroresValidacion['documentoIdentidad'] }}</span>
        </div>
      </div>

      <!-- Fila 3: Email y Contraseña -->
      <div class="form-row">
        <div class="form-grupo">
          <label>Email <span class="requerido">*</span></label>
          <input
            type="email"
            [(ngModel)]="usuarioEditando.email"
            [class.error]="erroresValidacion['email']"
            placeholder="ejemplo@correo.com"
            class="form-input"
          />
          <span class="error-text" *ngIf="erroresValidacion['email']">{{ erroresValidacion['email'] }}</span>
        </div>
        <div class="form-grupo">
          <label>
            Contraseña <span class="requerido" *ngIf="!modoEdicion">*</span>
            <span class="hint" *ngIf="modoEdicion">(Dejar vacío para mantener)</span>
          </label>
          <input
            type="password"
            [(ngModel)]="usuarioEditando.contrasena"
            [class.error]="erroresValidacion['contrasena']"
            placeholder="Ingrese la contraseña"
            class="form-input"
          />
          <span class="error-text" *ngIf="erroresValidacion['contrasena']">{{ erroresValidacion['contrasena'] }}</span>
        </div>
      </div>

      <!-- Fila 4: Área y Empresa -->
      <div class="form-row">
        <div class="form-grupo">
          <label>Área <span class="requerido">*</span></label>
          <select
            [(ngModel)]="usuarioEditando.areaId"
            [class.error]="erroresValidacion['areaId']"
            class="form-select"
          >
            <option [value]="0" disabled>Seleccione un área</option>
            <option *ngFor="let area of areas" [value]="area.areaId">{{ area.nombre }}</option>
          </select>
          <span class="error-text" *ngIf="erroresValidacion['areaId']">{{ erroresValidacion['areaId'] }}</span>
        </div>
        <div class="form-grupo">
          <label>Empresa <span class="requerido">*</span></label>
          <select
            [(ngModel)]="usuarioEditando.empresaId"
            [class.error]="erroresValidacion['empresaId']"
            class="form-select"
          >
            <option [value]="0" disabled>Seleccione una empresa</option>
            <option *ngFor="let empresa of empresas" [value]="empresa.empresaId">{{ empresa.nombre }}</option>
          </select>
          <span class="error-text" *ngIf="erroresValidacion['empresaId']">{{ erroresValidacion['empresaId'] }}</span>
        </div>
      </div>

      <!-- Fila 5: Estado -->
      <div class="form-row">
        <div class="form-grupo">
          <label>Estado</label>
          <select [(ngModel)]="usuarioEditando.estado" class="form-select">
            <option value="Activo">Activo</option>
            <option value="Inactivo">Inactivo</option>
          </select>
        </div>
      </div>

      <!-- Fila 6: Roles -->
      <div class="form-grupo full-width">
        <label>Roles <span class="requerido">*</span></label>
        <div class="roles-checkbox-group" [class.error]="erroresValidacion['rolesIds']">
          <div class="role-checkbox" *ngFor="let rol of roles">
            <input
              type="checkbox"
              [id]="'rol_' + rol.rolId"
              [checked]="tieneRol(rol.rolId)"
              (change)="toggleRol(rol.rolId)"
            />
            <label [for]="'rol_' + rol.rolId">{{ rol.nombre }}</label>
          </div>
          <div *ngIf="roles.length === 0" class="no-roles">No hay roles disponibles</div>
        </div>
        <span class="error-text" *ngIf="erroresValidacion['rolesIds']">{{ erroresValidacion['rolesIds'] }}</span>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancelar" (click)="cerrarModalForm()">Cancelar</button>
      <button class="btn-guardar" (click)="guardarUsuario()" [disabled]="cargando">
        {{ cargando ? 'Guardando...' : (modoEdicion ? 'Guardar Cambios' : 'Crear Usuario') }}
      </button>
    </div>
  </div>
</div>

<!-- Modal Detalle -->
<div class="modal-overlay" *ngIf="mostrarModalDetalle" (click)="cerrarModalDetalle()">
  <div class="modal-contenido modal-detalle" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Detalle del Usuario</h3>
      <button class="btn-cerrar" (click)="cerrarModalDetalle()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="modal-body" *ngIf="usuarioDetalle">
      <div class="detalle-grid">
        <div class="detalle-item">
          <span class="detalle-label">ID:</span>
          <span class="detalle-valor">{{ usuarioDetalle.usuarioId }}</span>
        </div>
        <div class="detalle-item">
          <span class="detalle-label">Estado:</span>
          <span class="detalle-valor">
            <span class="estado-badge" [class.estado-activo]="usuarioDetalle.estado === 'Activo'" [class.estado-inactivo]="usuarioDetalle.estado !== 'Activo'">
              {{ usuarioDetalle.estado }}
            </span>
          </span>
        </div>
        <div class="detalle-item full-width">
          <span class="detalle-label">Nombre:</span>
          <span class="detalle-valor">{{ usuarioDetalle.nombre }} {{ usuarioDetalle.apellido }}</span>
        </div>
        <div class="detalle-item">
          <span class="detalle-label">Usuario:</span>
          <span class="detalle-valor">{{ usuarioDetalle.usuario }}</span>
        </div>
        <div class="detalle-item">
          <span class="detalle-label">Email:</span>
          <span class="detalle-valor">{{ usuarioDetalle.email }}</span>
        </div>
        <div class="detalle-item">
          <span class="detalle-label">Documento:</span>
          <span class="detalle-valor">{{ usuarioDetalle.documentoIdentidad }}</span>
        </div>
        <div class="detalle-item">
          <span class="detalle-label">Área:</span>
          <span class="detalle-valor">{{ usuarioDetalle.areaNombre }}</span>
        </div>
        <div class="detalle-item">
          <span class="detalle-label">Empresa:</span>
          <span class="detalle-valor">{{ usuarioDetalle.empresaNombre }}</span>
        </div>
        <div class="detalle-item full-width">
          <span class="detalle-label">Roles:</span>
          <span class="detalle-valor">
            <div class="roles-badges">
              <span class="role-badge" *ngFor="let rol of usuarioDetalle.roles">{{ rol.nombre }}</span>
              <span *ngIf="!usuarioDetalle.roles || usuarioDetalle.roles.length === 0" class="sin-roles">Sin roles asignados</span>
            </div>
          </span>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancelar" (click)="cerrarModalDetalle()">Cerrar</button>
    </div>
  </div>
</div>
