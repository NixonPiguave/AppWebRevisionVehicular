<div class="empresas-container">
  <!-- Mensaje de error -->
  <div class="mensaje-error" *ngIf="error">
    {{ error }}
    <button class="btn-reintentar" (click)="cargarEmpresas()">Reintentar</button>
  </div>

  <!-- Loading -->
  <div class="cargando" *ngIf="cargando && !error">
    Cargando empresas...
  </div>

  <!-- Contenido principal -->
  <div *ngIf="!cargando || error">
    <!-- Header con título y botón agregar -->
    <div class="empresas-header">
      <h2>Gestión de Empresas</h2>
      <button class="btn-agregar" (click)="abrirModalCrear()">
        <mat-icon>add</mat-icon>
        Nueva Empresa
      </button>
    </div>

    <!-- Controles de filtro y paginación -->
    <div class="empresas-controles">
      <div class="control-grupo">
        <label for="filtro">Buscar:</label>
        <input
          type="text"
          id="filtro"
          [(ngModel)]="filtro"
          (ngModelChange)="onFiltroChange()"
          placeholder="Buscar por nombre, RUC, correo..."
          class="input-filtro"
        />
      </div>
      <div class="control-grupo">
        <label for="registros">Mostrar:</label>
        <select
          id="registros"
          [(ngModel)]="registrosPorPagina"
          (ngModelChange)="onFiltroChange()"
          class="select-registros"
        >
          <option [value]="10">10</option>
          <option [value]="25">25</option>
          <option [value]="50">50</option>
        </select>
        <span class="registros-texto">registros</span>
      </div>
    </div>

    <!-- Tabla -->
    <div class="tabla-contenedor">
      <table class="empresas-tabla">
        <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>RUC</th>
          <th>Correo</th>
          <th>Teléfono</th>
          <th class="th-acciones">Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let empresa of empresasPaginadas">
          <td>{{ empresa.empresaId }}</td>
          <td>{{ empresa.nombre }}</td>
          <td>{{ empresa.ruc }}</td>
          <td>{{ empresa.correo }}</td>
          <td>{{ empresa.telefono }}</td>
          <td class="td-acciones">
            <!-- Botón Ver Detalle -->
            <button
              class="btn-accion btn-ver"
              (click)="verDetalle(empresa)"
              title="Ver detalle"
            >
              <mat-icon>visibility</mat-icon>
            </button>
            <!-- Botón Editar -->
            <button
              class="btn-accion btn-editar"
              (click)="abrirModalEditar(empresa)"
              title="Editar"
            >
              <mat-icon>edit</mat-icon>
            </button>
          </td>
        </tr>
        <tr *ngIf="empresasPaginadas.length === 0 && !error && !cargando">
          <td colspan="6" class="sin-registros">No se encontraron registros</td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="paginacion" *ngIf="totalPaginas > 1">
      <button
        class="btn-pagina"
        (click)="irAPagina(paginaActual - 1)"
        [disabled]="paginaActual === 1"
      >
        Anterior
      </button>
      <button
        *ngFor="let pagina of paginas"
        class="btn-pagina"
        [class.activa]="pagina === paginaActual"
        (click)="irAPagina(pagina)"
      >
        {{ pagina }}
      </button>
      <button
        class="btn-pagina"
        (click)="irAPagina(paginaActual + 1)"
        [disabled]="paginaActual === totalPaginas"
      >
        Siguiente
      </button>
    </div>

    <!-- Info de registros -->
    <div class="info-registros" *ngIf="empresasFiltradas.length > 0">
      Mostrando {{ (paginaActual - 1) * registrosPorPagina + 1 }} a
      {{ paginaActual * registrosPorPagina > empresasFiltradas.length ? empresasFiltradas.length : paginaActual * registrosPorPagina }}
      de {{ empresasFiltradas.length }} registros
    </div>
  </div>
</div>

<!-- Modal Crear/Editar -->
<div class="modal-overlay" *ngIf="mostrarModalForm" (click)="cerrarModalForm()">
  <div class="modal-contenido modal-empresa" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ modoEdicion ? 'Editar Empresa' : 'Nueva Empresa' }}</h3>
      <button class="btn-cerrar" (click)="cerrarModalForm()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="modal-body">
      <!-- Nombre -->
      <div class="form-grupo">
        <label for="nombre">Nombre de la Empresa *</label>
        <input
          type="text"
          id="nombre"
          [(ngModel)]="empresaEditando.nombre"
          placeholder="Ingrese el nombre de la empresa"
          class="form-input"
        />
      </div>

      <!-- RUC -->
      <div class="form-grupo">
        <label for="ruc">RUC *</label>
        <input
          type="text"
          id="ruc"
          [(ngModel)]="empresaEditando.ruc"
          placeholder="Ingrese el RUC"
          class="form-input"
          maxlength="20"
        />
      </div>

      <!-- Dirección -->
      <div class="form-grupo">
        <label for="direccion">Dirección</label>
        <input
          type="text"
          id="direccion"
          [(ngModel)]="empresaEditando.direccion"
          placeholder="Ingrese la dirección"
          class="form-input"
        />
      </div>

      <!-- Teléfono -->
      <div class="form-grupo">
        <label for="telefono">Teléfono</label>
        <input
          type="text"
          id="telefono"
          [(ngModel)]="empresaEditando.telefono"
          placeholder="Ingrese el teléfono"
          class="form-input"
        />
      </div>

      <!-- Correo -->
      <div class="form-grupo">
        <label for="correo">Correo Electrónico *</label>
        <input
          type="email"
          id="correo"
          [(ngModel)]="empresaEditando.correo"
          placeholder="ejemplo@empresa.com"
          class="form-input"
        />
      </div>

      <!-- Logo -->
      <div class="form-grupo">
        <label>Logo de la Empresa</label>
        <div class="logo-upload-container">
          <!-- Preview del logo -->
          <div class="logo-preview" *ngIf="logoPreview">
            <img [src]="logoPreview" alt="Preview del logo" />
            <button type="button" class="btn-remover-logo" (click)="removerLogo()">
              <mat-icon>close</mat-icon>
            </button>
          </div>

          <!-- Input para seleccionar archivo -->
          <div class="logo-input-wrapper" *ngIf="!logoPreview">
            <input
              type="file"
              id="logo"
              (change)="onLogoSelected($event)"
              accept="image/*"
              class="logo-input"
            />
            <label for="logo" class="logo-input-label">
              <mat-icon>cloud_upload</mat-icon>
              <span>Seleccionar imagen</span>
            </label>
          </div>

          <!-- Nombre del archivo -->
          <div class="logo-filename" *ngIf="empresaEditando.logoempresa">
            <mat-icon>image</mat-icon>
            <span>{{ empresaEditando.logoempresa }}</span>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancelar" (click)="cerrarModalForm()" [disabled]="guardando">Cancelar</button>
      <button class="btn-guardar" (click)="guardarEmpresa()" [disabled]="guardando">
        {{ guardando ? 'Guardando...' : (modoEdicion ? 'Guardar Cambios' : 'Crear Empresa') }}
      </button>
    </div>
  </div>
</div>

<!-- Modal Detalle -->
<div class="modal-overlay" *ngIf="mostrarModalDetalle" (click)="cerrarModalDetalle()">
  <div class="modal-contenido modal-detalle" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Detalle de la Empresa</h3>
      <button class="btn-cerrar" (click)="cerrarModalDetalle()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="modal-body" *ngIf="empresaDetalle">
      <!-- Logo en detalle - centrado arriba -->
      <div class="detalle-logo-container">
        <div class="detalle-logo" *ngIf="empresaDetalle.logoempresa && empresaDetalle.logoempresa.length > 50">
          <img [src]="empresaDetalle.logoempresa" alt="Logo de {{ empresaDetalle.nombre }}" />
        </div>
        <div class="detalle-logo-placeholder" *ngIf="!empresaDetalle.logoempresa || empresaDetalle.logoempresa.length <= 50">
          <mat-icon>business</mat-icon>
          <span>Sin logo</span>
        </div>
      </div>

      <div class="detalle-item">
        <span class="detalle-label">ID:</span>
        <span class="detalle-valor">{{ empresaDetalle.empresaId }}</span>
      </div>
      <div class="detalle-item">
        <span class="detalle-label">Nombre:</span>
        <span class="detalle-valor">{{ empresaDetalle.nombre }}</span>
      </div>
      <div class="detalle-item">
        <span class="detalle-label">RUC:</span>
        <span class="detalle-valor">{{ empresaDetalle.ruc }}</span>
      </div>
      <div class="detalle-item">
        <span class="detalle-label">Dirección:</span>
        <span class="detalle-valor">{{ empresaDetalle.direccion || 'No especificada' }}</span>
      </div>
      <div class="detalle-item">
        <span class="detalle-label">Teléfono:</span>
        <span class="detalle-valor">{{ empresaDetalle.telefono || 'No especificado' }}</span>
      </div>
      <div class="detalle-item">
        <span class="detalle-label">Correo:</span>
        <span class="detalle-valor">{{ empresaDetalle.correo }}</span>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancelar" (click)="cerrarModalDetalle()">Cerrar</button>
    </div>
  </div>
</div>
